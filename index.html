<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alloy Nominal Values Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e;
            color: #ffffff;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #2d2d30;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #007acc;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .step-title {
            font-size: 1.4em;
            color: #007acc;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007acc;
        }

        .step {
            display: none;
            margin-bottom: 30px;
        }

        .step.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #ffffff;
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 15px;
            background-color: #3c3c3c;
            border: 1px solid #555;
            border-radius: 4px;
            color: #ffffff;
            font-size: 18px;
            font-weight: 600;
        }

        select option {
            padding: 10px;
            margin: 5px 0;
            font-size: 18px;
            font-weight: 600;
            background-color: #3c3c3c;
            color: #ffffff;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 5px rgba(0, 122, 204, 0.3);
        }

        .selected-values {
            background-color: #3c3c3c;
            padding: 20px;
            border-radius: 6px;
            margin-top: 20px;
            border: 1px solid #555;
        }

        .element-input {
            display: grid;
            grid-template-columns: 120px 1fr 100px;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #3c3c3c;
            border-radius: 4px;
        }

        .element-label {
            font-weight: 600;
            color: #ffffff;
        }

        .nominal-value {
            font-size: 12px;
            color: #cccccc;
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }

        button {
            padding: 12px 24px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        button:hover:not(:disabled) {
            background-color: #005a9e;
        }

        button:disabled {
            background-color: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .clear-btn {
            background-color: #dc3545;
        }

        .clear-btn:hover {
            background-color: #c82333;
        }

        .results-summary {
            background-color: #3c3c3c;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border: 1px solid #555;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .results-table th,
        .results-table td {
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #555;
        }

        .results-table th {
            background-color: #2d2d30;
            color: #007acc;
            font-weight: 600;
        }

        .final-results {
            margin-top: 20px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background-color: #3c3c3c;
            border-radius: 4px;
        }

        .result-value {
            color: #007acc;
            font-weight: bold;
            font-size: 16px;
        }

        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }

        .success {
            color: #28a745;
            font-size: 14px;
            margin-top: 10px;
        }

        .export-btn {
            background-color: #28a745;
            margin-top: 20px;
        }

        .export-btn:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Alloy Nominal Values Calculator</h1>

        <!-- Step 1: Selection -->
        <div id="step1" class="step active">
            <div class="step-title">Step 1: Select Alloy Group and Code</div>
            
            <div class="form-group">
                <label for="alloyGroup">Alloy Group:</label>
                <select id="alloyGroup" onchange="updateAlloyCode()">
                    <option value="6063">6063</option>
                    <option value="6005A">6005A</option>
                    <option value="6061">6061</option>
                    <option value="6082 HO">6082 HO</option>
                    <option value="6061 HO">6061 HO</option>
                </select>
            </div>

            <div class="form-group">
                <label for="alloyCode">Alloy Code:</label>
                <select id="alloyCode" disabled onchange="updateSelectedValues()">
                </select>
            </div>

            <div class="selected-values">
                <h3>Selected Values:</h3>
                <p id="selectedGroup">Alloy Group: Not selected</p>
                <p id="selectedCode">Alloy Code: Not selected</p>
                
                <div style="margin-top: 15px; padding: 15px; background-color: #2d2d30; border-radius: 6px; border: 2px solid #007acc;">
                    <h4 style="color: #007acc; margin-bottom: 10px;">üìÅ Base Folder Setup</h4>
                    <p id="baseFolderStatus" style="color: #cccccc; margin-bottom: 10px;">No base folder selected</p>
                    <button id="browseBtn" onclick="selectBaseFolder()" style="background-color: #007acc; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">Browse</button>
                    <p style="font-size: 12px; color: #888; margin-top: 8px;">‚ö†Ô∏è Required: Select base folder to organize Excel files</p>
                </div>
                
                <button class="clear-btn" onclick="clearAllInputs()" style="margin-top: 15px;">Clear All Inputs</button>
            </div>
        </div>

        <!-- Step 2: Furnace Analysis -->
        <div id="step2" class="step">
            <div class="step-title">Step 2: Enter Furnace Analysis</div>
            <p style="margin-bottom: 20px; color: #cccccc;">Enter furnace analysis values for each element (optional):</p>
            <div id="furnaceInputs"></div>
        </div>

        <!-- Step 3: Weight -->
        <div id="step3" class="step">
            <div class="step-title">Step 3: Enter Total Weight</div>
            <div class="form-group">
                <label for="totalWeight">Total Weight (pounds):</label>
                <input type="number" id="totalWeight" step="0.01" placeholder="Enter weight in pounds">
            </div>
        </div>

        <!-- Step 4: Recovery -->
        <div id="step4" class="step">
            <div class="step-title">Step 4: Enter Recovery Percentages</div>
            <p style="margin-bottom: 20px; color: #cccccc;">Enter recovery percentages for each element (optional):</p>
            <div id="recoveryInputs"></div>
        </div>

        <!-- Step 5: Results -->
        <div id="step5" class="step">
            <div class="step-title">Step 5: Results</div>
            <div id="resultsContainer"></div>
        </div>

        <!-- Navigation Buttons -->
        <div class="buttons">
            <button id="prevBtn" onclick="previousStep()" disabled>Previous</button>
            <button id="nextBtn" onclick="nextStep()">Next</button>
        </div>
    </div>

    <script>
        // Data structures
        const alloyData = {
            "6063": ["765047", "765046"],
            "6005A": ["765342"],
            "6061": ["769236"],
            "6082 HO": ["767344"],
            "6061 HO": ["769201"]
        };

        const nominalValues = {
            "765047": { "Silicon": 0.45, "Iron": 0.19, "Copper": 0.0, "Manganese": 0.04, "Magnesium": 0.49, "Chromium": 0.0 },
            "765046": { "Silicon": 0.45, "Iron": 0.19, "Copper": 0.0, "Manganese": 0.04, "Magnesium": 0.50, "Chromium": 0.0 },
            "765342": { "Silicon": 0.70, "Iron": 0.22, "Copper": 0.10, "Manganese": 0.24, "Magnesium": 0.50, "Chromium": 0.0 },
            "769236": { "Silicon": 0.65, "Iron": 0.21, "Copper": 0.19, "Manganese": 0.08, "Magnesium": 0.85, "Chromium": 0.06 },
            "767344": { "Silicon": 1.05, "Iron": 0.21, "Copper": 0.07, "Manganese": 0.50, "Magnesium": 0.65, "Chromium": 0.08 },
            "769201": { "Silicon": 0.70, "Iron": 0.20, "Copper": 0.18, "Manganese": 0.13, "Magnesium": 0.85, "Chromium": 0.11 }
        };

        const elements = ["Silicon", "Iron", "Copper", "Manganese", "Magnesium", "Chromium"];
        
        let currentStep = 1;
        let selectedAlloyGroup = "";
        let selectedAlloyCode = "";
        let furnaceAnalysis = {};
        let totalWeight = 0;
        let recoveryPercentages = {};
        let clearedElements = {}; // Track elements that were cleared for being > nominal
        // Store the base folder handle in multiple places to prevent loss
        let baseFolderHandle = null;
        let isBaseFolderSet = false;
        
        // Create a persistent storage for the folder handle
        window.alloyCalculatorData = window.alloyCalculatorData || {
            folderHandle: null,
            isConfigured: false
        };

        // Initialize the application
        function init() {
            // Initialize with default selection (6063 is pre-selected in HTML)
            updateAlloyCode();
            checkBaseFolderStatus();
            updateNavigationButtons();
        }

        // Check if base folder is actually accessible (not just saved in localStorage)
        async function checkBaseFolderStatus() {
            const savedBaseFolderName = localStorage.getItem('alloyCalculatorBaseFolder');
            
            // First check if we have any active folder handles
            const hasActiveHandle = baseFolderHandle || 
                                  (window.alloyCalculatorData && window.alloyCalculatorData.folderHandle) || 
                                  window.selectedBaseFolderHandle;
            
            if (savedBaseFolderName && hasActiveHandle) {
                // We have both saved name AND active handle - folder is truly configured
                isBaseFolderSet = true;
                window.alloyCalculatorData.isConfigured = true;
                document.getElementById('baseFolderStatus').textContent = `Base folder: ${savedBaseFolderName}`;
                document.getElementById('baseFolderStatus').style.color = '#28a745';
                document.getElementById('browseBtn').textContent = 'Change Folder';
                document.getElementById('browseBtn').style.backgroundColor = '#6c757d';
                console.log('DEBUG: Folder is truly accessible:', savedBaseFolderName);
            } else if (savedBaseFolderName && !hasActiveHandle) {
                // We have saved name but NO active handle - folder access was lost
                console.log('DEBUG: Folder handle lost, requiring re-selection');
                isBaseFolderSet = false;
                window.alloyCalculatorData.isConfigured = false;
                document.getElementById('baseFolderStatus').textContent = 'Folder access lost - please re-select';
                document.getElementById('baseFolderStatus').style.color = '#dc3545';
                document.getElementById('browseBtn').textContent = 'Browse';
                document.getElementById('browseBtn').style.backgroundColor = '#007acc';
            } else {
                // No folder configured at all
                isBaseFolderSet = false;
                window.alloyCalculatorData.isConfigured = false;
                document.getElementById('baseFolderStatus').textContent = 'No base folder selected';
                document.getElementById('baseFolderStatus').style.color = '#cccccc';
                document.getElementById('browseBtn').textContent = 'Browse';
                document.getElementById('browseBtn').style.backgroundColor = '#007acc';
            }
        }

        // Select base folder (one-time setup)
        async function selectBaseFolder() {
            try {
                if (!window.showDirectoryPicker) {
                    alert('Folder selection is not supported in this browser.\n\nPlease use Chrome, Edge, or another Chromium-based browser.');
                    return;
                }

                const directoryHandle = await window.showDirectoryPicker();
                
                // Store in multiple locations to prevent loss
                baseFolderHandle = directoryHandle;
                isBaseFolderSet = true;
                window.alloyCalculatorData.folderHandle = directoryHandle;
                window.alloyCalculatorData.isConfigured = true;
                window.selectedBaseFolderHandle = directoryHandle;
                
                // Save to localStorage for persistence across sessions
                localStorage.setItem('alloyCalculatorBaseFolder', directoryHandle.name);
                localStorage.setItem('alloyCalculatorBaseFolderConfigured', 'true');
                
                // Update UI
                document.getElementById('baseFolderStatus').textContent = `Base folder: ${directoryHandle.name}`;
                document.getElementById('baseFolderStatus').style.color = '#28a745';
                document.getElementById('browseBtn').textContent = 'Change Folder';
                document.getElementById('browseBtn').style.backgroundColor = '#6c757d';
                
                updateNavigationButtons();
                alert(`Base folder configured: ${directoryHandle.name}\n\nExcel files will be organized in subfolders by Alloy Group and Code.`);
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    return; // User cancelled
                }
                console.error('Folder selection error:', error);
                alert('Error selecting folder. Please try again.');
            }
        }

        function updateAlloyCode() {
            const alloyGroup = document.getElementById('alloyGroup').value;
            const alloyCodeSelect = document.getElementById('alloyCode');
            
            alloyCodeSelect.innerHTML = '';
            alloyCodeSelect.disabled = !alloyGroup;
            
            if (alloyGroup && alloyData[alloyGroup]) {
                alloyData[alloyGroup].forEach(code => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = code;
                    alloyCodeSelect.appendChild(option);
                });
                // Enable the select and trigger change to update selected values
                alloyCodeSelect.disabled = false;
            }
            
            selectedAlloyGroup = alloyGroup;
            updateSelectedValues();
        }

        function updateSelectedValues() {
            const alloyGroup = document.getElementById('alloyGroup').value;
            const alloyCode = document.getElementById('alloyCode').value;
            
            selectedAlloyGroup = alloyGroup;
            selectedAlloyCode = alloyCode;
            
            document.getElementById('selectedGroup').textContent = `Alloy Group: ${alloyGroup || 'Not selected'}`;
            document.getElementById('selectedCode').textContent = `Alloy Code: ${alloyCode || 'Not selected'}`;
            
            updateNavigationButtons();
        }

        function createFurnaceInputs() {
            const container = document.getElementById('furnaceInputs');
            container.innerHTML = '';
            
            elements.forEach(element => {
                const div = document.createElement('div');
                div.className = 'element-input';
                
                const nominal = selectedAlloyCode && nominalValues[selectedAlloyCode] ? 
                    nominalValues[selectedAlloyCode][element] : 0;
                
                div.innerHTML = `
                    <div class="element-label">${element}:</div>
                    <input type="number" id="furnace_${element}" step="0.001" placeholder="Enter value" 
                           value="${furnaceAnalysis[element] || ''}" onchange="validateFurnaceInput('${element}')">
                    <div class="nominal-value">Nominal: ${nominal.toFixed(3)}</div>
                `;
                
                container.appendChild(div);
            });
        }

        function validateFurnaceInput(element) {
            const input = document.getElementById(`furnace_${element}`);
            const enteredValue = parseFloat(input.value);
            
            if (!isNaN(enteredValue) && selectedAlloyCode && nominalValues[selectedAlloyCode]) {
                const nominalValue = nominalValues[selectedAlloyCode][element];
                
                if (enteredValue > nominalValue) {
                    alert('No need to add anything');
                    input.value = ''; // Clear the input field instantly
                    input.focus(); // Optional: keep focus on the cleared field
                    clearedElements[element] = true; // Mark this element as cleared
                    return false;
                } else {
                    // If user enters a valid value, remove it from cleared elements
                    delete clearedElements[element];
                }
            }
            return true;
        }

        function createRecoveryInputs() {
            const container = document.getElementById('recoveryInputs');
            container.innerHTML = '';
            
            elements.forEach(element => {
                const div = document.createElement('div');
                div.className = 'element-input';
                
                const difference = calculateDifference(element);
                
                div.innerHTML = `
                    <div class="element-label">${element}:</div>
                    <input type="number" id="recovery_${element}" step="0.1" placeholder="Enter percentage" 
                           value="${recoveryPercentages[element] || ''}">
                    <div class="nominal-value">Diff: ${difference.toFixed(4)}</div>
                `;
                
                container.appendChild(div);
            });
        }

        function calculateDifference(element) {
            if (!furnaceAnalysis[element] || !selectedAlloyCode || !nominalValues[selectedAlloyCode]) {
                return 0;
            }
            
            const furnaceValue = parseFloat(furnaceAnalysis[element]);
            const nominalValue = nominalValues[selectedAlloyCode][element];
            return Math.abs(furnaceValue - nominalValue);
        }

        function validateFurnaceAnalysis() {
            furnaceAnalysis = {};
            
            elements.forEach(element => {
                const input = document.getElementById(`furnace_${element}`);
                if (input && input.value.trim() !== '') {
                    const value = parseFloat(input.value);
                    if (!isNaN(value)) {
                        furnaceAnalysis[element] = value;
                    }
                }
            });
            
            return true;
        }

        function validateWeight() {
            const weightInput = document.getElementById('totalWeight');
            const weight = parseFloat(weightInput.value);
            
            if (weightInput.value.trim() !== '' && (!isNaN(weight) && weight > 0)) {
                totalWeight = weight;
                return true;
            } else if (weightInput.value.trim() === '') {
                totalWeight = 0;
                return true;
            }
            
            alert('Please enter a valid weight in pounds');
            return false;
        }

        function validateRecovery() {
            recoveryPercentages = {};
            
            elements.forEach(element => {
                const input = document.getElementById(`recovery_${element}`);
                if (input && input.value.trim() !== '') {
                    const value = parseFloat(input.value);
                    if (!isNaN(value) && value > 0) {
                        recoveryPercentages[element] = value;
                    }
                }
            });
            
            return true;
        }

        function calculateResults() {
            const results = {};
            
            elements.forEach(element => {
                if (furnaceAnalysis[element] && recoveryPercentages[element]) {
                    const difference = calculateDifference(element);
                    const weight = totalWeight || 0;
                    const recovery = recoveryPercentages[element];
                    
                    if (recovery !== 0) {
                        const result = ((difference * weight) / 100) * 100 / recovery;
                        results[element] = result;
                    }
                }
            });
            
            return results;
        }

        function displayResults() {
            const container = document.getElementById('resultsContainer');
            const results = calculateResults();
            
            // Auto-save Excel file when results are displayed
            setTimeout(() => {
                saveExcelToStructuredFolder();
            }, 500); // Small delay to ensure UI is rendered first
            
            let html = `
                <div class="results-summary">
                    <h3>Input Summary</h3>
                    <p><strong>Alloy Group:</strong> ${selectedAlloyGroup} | <strong>Code:</strong> ${selectedAlloyCode} | <strong>Weight:</strong> ${totalWeight} lbs</p>
                    
                    <h4 style="margin-top: 15px;">Furnace Analysis:</h4>
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th>Element</th>
                                <th>Furnace Analysis</th>
                                <th>Recovery%</th>
                                <th>Difference</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            elements.forEach(element => {
                if (furnaceAnalysis[element]) {
                    const recovery = recoveryPercentages[element] || '';
                    const difference = calculateDifference(element);
                    
                    html += `
                        <tr>
                            <td>${element}</td>
                            <td>${furnaceAnalysis[element].toFixed(3)}</td>
                            <td>${recovery ? recovery.toFixed(1) + '%' : ''}</td>
                            <td>${difference.toFixed(4)}</td>
                        </tr>
                    `;
                }
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <div class="final-results">
                    <h3>Required Element Weight (LBS):</h3>
            `;
            
            // Show results for all elements
            elements.forEach(element => {
                if (results[element]) {
                    // Element has calculated result
                    html += `
                        <div class="result-item">
                            <span>${element}:</span>
                            <span class="result-value">${Math.round(results[element])}</span>
                        </div>
                    `;
                } else if (clearedElements[element]) {
                    // Element was cleared for being > nominal
                    html += `
                        <div class="result-item">
                            <span>${element}:</span>
                            <span class="result-value" style="color: #28a745;">No need to add anything</span>
                        </div>
                    `;
                } else {
                    // Element was left blank or has no recovery percentage
                    html += `
                        <div class="result-item">
                            <span>${element}:</span>
                            <span class="result-value" style="color: #dc3545;">No need to add anything</span>
                        </div>
                    `;
                }
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function nextStep() {
            if (currentStep === 1) {
                if (!selectedAlloyGroup || !selectedAlloyCode) {
                    alert('Please select both alloy group and code');
                    return;
                }
                createFurnaceInputs();
            } else if (currentStep === 2) {
                if (!validateFurnaceAnalysis()) return;
            } else if (currentStep === 3) {
                if (!validateWeight()) return;
                createRecoveryInputs();
            } else if (currentStep === 4) {
                if (!validateRecovery()) return;
                displayResults();
            }
            
            if (currentStep < 5) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep++;
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateNavigationButtons();
            }
        }

        function previousStep() {
            if (currentStep > 1) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                currentStep--;
                document.getElementById(`step${currentStep}`).classList.add('active');
                updateNavigationButtons();
                
                // Preserve values when going back
                if (currentStep === 3) {
                    const weightInput = document.getElementById('totalWeight');
                    if (totalWeight > 0) {
                        weightInput.value = totalWeight.toFixed(2);
                    }
                }
            }
        }

        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentStep === 1;
            
            if (currentStep === 1) {
                nextBtn.disabled = !selectedAlloyGroup || !selectedAlloyCode || !isBaseFolderSet;
            } else if (currentStep === 5) {
                nextBtn.style.display = 'none';
            } else {
                nextBtn.disabled = false;
                nextBtn.style.display = 'block';
            }
        }

        function clearAllInputs() {
            // Reset all data
            selectedAlloyGroup = "";
            selectedAlloyCode = "";
            nominalValues = {};
            furnaceAnalysis = {};
            totalWeight = 0;
            recoveryPercentages = {};
            clearedElements = {}; // Reset cleared elements tracking
            
            // Reset form elements
            document.getElementById('alloyGroup').value = '';
            document.getElementById('alloyCode').value = '';
            document.getElementById('alloyCode').disabled = true;
            document.getElementById('totalWeight').value = '';
            
            // Keep folder handle active - don't reset it
            // Ensure folder handle stays active
            if (!baseFolderHandle && window.alloyCalculatorData.folderHandle) {
                baseFolderHandle = window.alloyCalculatorData.folderHandle;
            }
            
            // Reset display
            document.getElementById('selectedGroup').textContent = 'Alloy Group: Not selected';
            document.getElementById('selectedCode').textContent = 'Alloy Code: Not selected';
            
            // Go back to step 1
            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep = 1;
            document.getElementById('step1').classList.add('active');
            
            // Re-check folder status to ensure UI is accurate
            checkBaseFolderStatus();
            updateNavigationButtons();
            
            alert('All inputs have been cleared.');
        }


        // Generate Excel workbook (shared function)
        function generateExcelWorkbook() {
            // Create workbook
            const wb = XLSX.utils.book_new();
                
                // Create summary sheet
                const summaryData = [
                    ['Alloy Nominal Values Calculator Results'],
                    [''],
                    ['Alloy Group:', selectedAlloyGroup],
                    ['Alloy Code:', selectedAlloyCode],
                    ['Total Weight (lbs):', totalWeight],
                    [''],
                    ['Nominal Values'],
                    ['Element', 'Nominal Value']
                ];
                
                // Add nominal values from predefined data
                if (selectedAlloyCode && nominalValues[selectedAlloyCode]) {
                    elements.forEach(element => {
                        const nominalValue = nominalValues[selectedAlloyCode][element];
                        summaryData.push([element, nominalValue.toFixed(3)]);
                    });
                }
                
                summaryData.push(['']);
                summaryData.push(['Furnace Analysis & Results']);
                summaryData.push(['Element', 'Furnace Analysis', 'Recovery %', 'Difference', 'Required Weight (LBS)']);
                
                // Add furnace analysis and results
                const results = calculateResults();
                elements.forEach(element => {
                    if (furnaceAnalysis[element] || clearedElements[element] || results[element]) {
                        const recovery = recoveryPercentages[element] || '';
                        const difference = calculateDifference(element);
                        let requiredWeight = '';
                        
                        if (results[element]) {
                            requiredWeight = Math.round(results[element]);
                        } else if (clearedElements[element]) {
                            requiredWeight = 'No need to add anything';
                        } else {
                            requiredWeight = 'No need to add anything';
                        }
                        
                        summaryData.push([
                            element,
                            furnaceAnalysis[element] ? furnaceAnalysis[element].toFixed(3) : '',
                            recovery ? recovery.toFixed(1) + '%' : '',
                            difference.toFixed(4),
                            requiredWeight
                        ]);
                    }
                });
                
                // Create worksheet
                const ws = XLSX.utils.aoa_to_sheet(summaryData);
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(wb, ws, 'Alloy Calculator Results');
                
                // Generate filename with timestamp
                const now = new Date();
                const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
                const filename = `Alloy_Calculator_Results_${selectedAlloyGroup}_${selectedAlloyCode}_${timestamp}.xlsx`;
                
                return { workbook: wb, filename: filename };
        }

        // Get the active folder handle from any available source
        function getActiveFolderHandle() {
            // Try multiple sources in order of preference
            if (baseFolderHandle) {
                return baseFolderHandle;
            }
            if (window.alloyCalculatorData && window.alloyCalculatorData.folderHandle) {
                baseFolderHandle = window.alloyCalculatorData.folderHandle;
                return baseFolderHandle;
            }
            if (window.selectedBaseFolderHandle) {
                baseFolderHandle = window.selectedBaseFolderHandle;
                return baseFolderHandle;
            }
            
            return null;
        }

        // Save Excel to structured folder system
        async function saveExcelToStructuredFolder() {
            try {
                // Get the active folder handle
                const activeHandle = getActiveFolderHandle();
                
                if (!activeHandle && isBaseFolderSet) {
                    // Handle was lost - this shouldn't happen in same session
                    // For now, just use regular download and inform user
                    const { workbook, filename } = generateExcelWorkbook();
                    XLSX.writeFile(workbook, filename);
                    
                    // Show a non-intrusive message
                    const errorMsg = document.createElement('div');
                    errorMsg.style.cssText = `
                        position: fixed; top: 20px; right: 20px; 
                        background-color: #dc3545; color: white; 
                        padding: 15px 20px; border-radius: 8px; 
                        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                        z-index: 1000; font-weight: 600;
                    `;
                    errorMsg.innerHTML = `
                        ‚ö†Ô∏è Folder access lost<br>
                        <small>File saved to Downloads instead</small>
                    `;
                    document.body.appendChild(errorMsg);
                    setTimeout(() => errorMsg.remove(), 3000);
                    return;
                } else if (!activeHandle && !isBaseFolderSet) {
                    // No folder configured at all
                    const { workbook, filename } = generateExcelWorkbook();
                    XLSX.writeFile(workbook, filename);
                    
                    const infoMsg = document.createElement('div');
                    infoMsg.style.cssText = `
                        position: fixed; top: 20px; right: 20px; 
                        background-color: #007acc; color: white; 
                        padding: 15px 20px; border-radius: 8px; 
                        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                        z-index: 1000; font-weight: 600;
                    `;
                    infoMsg.innerHTML = `
                        üìÅ File saved to Downloads<br>
                        <small>Select base folder in Step 1 for custom location</small>
                    `;
                    document.body.appendChild(infoMsg);
                    setTimeout(() => infoMsg.remove(), 4000);
                    return;
                }
                
                // Use the active handle
                baseFolderHandle = activeHandle;

                // Generate the Excel file
                const { workbook, filename } = generateExcelWorkbook();
                
                // Create folder structure: Base ‚Üí Alloy Group ‚Üí Alloy Code
                let alloyGroupFolder;
                try {
                    alloyGroupFolder = await baseFolderHandle.getDirectoryHandle(selectedAlloyGroup, { create: true });
                } catch (error) {
                    console.error('Error creating alloy group folder:', error);
                    throw new Error(`Could not create folder for alloy group: ${selectedAlloyGroup}`);
                }
                
                let alloyCodeFolder;
                try {
                    alloyCodeFolder = await alloyGroupFolder.getDirectoryHandle(selectedAlloyCode, { create: true });
                } catch (error) {
                    console.error('Error creating alloy code folder:', error);
                    throw new Error(`Could not create folder for alloy code: ${selectedAlloyCode}`);
                }
                
                // Convert workbook to buffer
                const buffer = XLSX.write(workbook, { type: 'array', bookType: 'xlsx' });
                
                // Save file in the structured folder
                const fileHandle = await alloyCodeFolder.getFileHandle(filename, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(buffer);
                await writable.close();
                
                const baseFolderName = localStorage.getItem('alloyCalculatorBaseFolder') || 'Selected folder';
                // Show success message in a less intrusive way
                const successMsg = document.createElement('div');
                successMsg.style.cssText = `
                    position: fixed; top: 20px; right: 20px; 
                    background-color: #28a745; color: white; 
                    padding: 15px 20px; border-radius: 8px; 
                    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
                    z-index: 1000; font-weight: 600;
                    animation: slideIn 0.3s ease-out;
                `;
                successMsg.innerHTML = `
                    ‚úÖ Excel file saved automatically!<br>
                    <small style="opacity: 0.9;">üìÅ ${baseFolderName}/${selectedAlloyGroup}/${selectedAlloyCode}/</small>
                `;
                
                // Add CSS animation
                if (!document.getElementById('slideInStyle')) {
                    const style = document.createElement('style');
                    style.id = 'slideInStyle';
                    style.textContent = `
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(successMsg);
                
                // Remove message after 4 seconds
                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.remove();
                    }
                }, 4000);
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    return; // User cancelled
                }
                console.error('Save error:', error);
                alert('Error saving Excel file. Please ensure you have write permissions to the selected folder.');
            }
        }


        // Initialize the application
        init();
    </script>
</body>
</html>
